<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Portfolio Monitor Â· Overview</title>
		<style>
			:root {
				color-scheme: dark;
				font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
				background: #04060b;
				color: #f4f6ff;
			}
			body {
				margin: 0;
				min-height: 100vh;
				background: radial-gradient(circle at top left, #1a2740, #05070c);
			}
			header {
				padding: 2rem 1.5rem 0.5rem;
				text-align: center;
			}
			header h1 {
				margin: 0;
				font-size: clamp(2rem, 3vw, 3rem);
				letter-spacing: 0.1em;
			}
			header p {
				margin: 0.5rem 0 0;
				opacity: 0.75;
			}
			nav {
				display: flex;
				justify-content: center;
				gap: 1rem;
				padding: 1rem 0 0.5rem;
			}
			nav a {
				color: rgba(255, 255, 255, 0.8);
				text-decoration: none;
				font-weight: 600;
				padding: 0.4rem 0.9rem;
				border-radius: 999px;
				border: 1px solid transparent;
			}
			nav a[aria-current="page"] {
				border-color: rgba(255, 255, 255, 0.3);
				background: rgba(255, 255, 255, 0.08);
				color: #fff;
			}
			main {
				max-width: 1100px;
				margin: 0 auto;
				padding: 0 1.5rem 4rem;
				display: grid;
				gap: 1.5rem;
			}
			section {
				background: rgba(7, 11, 19, 0.85);
				border: 1px solid rgba(255, 255, 255, 0.07);
				border-radius: 18px;
				padding: 1.5rem;
				backdrop-filter: blur(12px);
				box-shadow: 0 18px 40px rgba(4, 8, 20, 0.55);
			}
			#overview-actions {
				display: flex;
				flex-wrap: wrap;
				justify-content: center;
				gap: 1rem;
				margin-bottom: 0.5rem;
			}
			button,
			a.cta {
				border: none;
				border-radius: 999px;
				padding: 0.85rem 1.5rem;
				font-weight: 600;
				cursor: pointer;
				background: linear-gradient(135deg, #58c5ff, #7b70ff);
				color: #041026;
				box-shadow: 0 12px 30px rgba(92, 149, 255, 0.35);
				text-decoration: none;
				display: inline-flex;
				align-items: center;
				gap: 0.4rem;
			}
			button:disabled {
				opacity: 0.65;
				cursor: progress;
			}
			#metrics {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
				gap: 1rem;
			}
			.metric-card {
				background: linear-gradient(135deg, rgba(66, 105, 182, 0.95), rgba(16, 30, 53, 0.95));
				border-radius: 16px;
				padding: 1rem 1.25rem;
				display: flex;
				flex-direction: column;
				gap: 0.4rem;
				box-shadow: 0 18px 40px rgba(4, 8, 20, 0.55);
			}
			.metric-card h2,
			.metric-card h3 {
				margin: 0;
				font-size: 0.85rem;
				text-transform: uppercase;
				letter-spacing: 0.08em;
				color: rgba(229, 236, 255, 0.8);
			}
			.metric-card p {
				margin: 0;
				font-size: 1.6rem;
				font-weight: 600;
			}
			#chart-container {
				display: grid;
				grid-template-columns: minmax(220px, 320px) 1fr;
				gap: 1.5rem;
				align-items: center;
			}
			#chart-canvas {
				width: 100%;
				max-width: 320px;
				height: auto;
				justify-self: center;
			}
			#chart-legend {
				display: flex;
				flex-direction: column;
				gap: 0.75rem;
			}
			.legend-item {
				display: grid;
				grid-template-columns: 16px 1fr auto;
				gap: 0.75rem;
				align-items: center;
			}
			.legend-swatch {
				width: 16px;
				height: 16px;
				border-radius: 50%;
			}
			table {
				width: 100%;
				border-collapse: collapse;
			}
			th,
			td {
				padding: 0.75rem 0.5rem;
				border-bottom: 1px solid rgba(255, 255, 255, 0.06);
				text-align: left;
			}
			th {
				font-size: 0.75rem;
				text-transform: uppercase;
				letter-spacing: 0.08em;
				color: rgba(186, 198, 223, 0.8);
			}
			td.status-ok {
				color: #6ee7a6;
			}
			td.status-error {
				color: #f08c8c;
			}
			@media (max-width: 900px) {
				#chart-container {
					grid-template-columns: 1fr;
				}
			}
		</style>
	</head>
	<body>
		<header>
			<h1>Portfolio Monitor</h1>
			<p>Stay on top of your blockchain wallets and physical holdings with daily price snapshots.</p>
			<nav>
				<a href="/" aria-current="page">Overview</a>
				<a href="/manage">Portfolio management</a>
			</nav>
		</header>
		<main>
			<section id="metrics">
				<div class="metric-card">
					<h2>Total value</h2>
					<p id="total-usd">--</p>
				</div>
				<div class="metric-card">
					<h3>Blockchain</h3>
					<p id="blockchain-share">--</p>
				</div>
				<div class="metric-card">
					<h3>Physical</h3>
					<p id="physical-share">--</p>
				</div>
				<div class="metric-card">
					<h3>Last refresh</h3>
					<p id="last-updated">--</p>
				</div>
			</section>

			<section>
				<h2>Allocation</h2>
				<div id="chart-container">
					<canvas id="chart-canvas" width="320" height="320"></canvas>
					<div id="chart-legend"></div>
				</div>
			</section>

			<section>
				<h2>Holdings</h2>
				<div style="overflow-x: auto">
					<table>
						<thead>
							<tr>
								<th>Label</th>
								<th>Type</th>
								<th>Quantity</th>
								<th>Price</th>
								<th>Value</th>
								<th>Status</th>
							</tr>
						</thead>
						<tbody id="asset-rows"></tbody>
					</table>
				</div>
			</section>
		</main>

		<script type="module">
			const state = {
				currency: new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }),
				number: new Intl.NumberFormat("en-US", { maximumFractionDigits: 6 }),
				colors: ["#5f5bff", "#56d9ff", "#7ee085", "#f9a8d4", "#f97373", "#facc15"],
			};

			const totalUsdEl = document.getElementById("total-usd");
			const blockchainEl = document.getElementById("blockchain-share");
			const physicalEl = document.getElementById("physical-share");
			const lastUpdatedEl = document.getElementById("last-updated");
			const assetRowsEl = document.getElementById("asset-rows");
			const chartCanvas = document.getElementById("chart-canvas");
			const chartLegend = document.getElementById("chart-legend");
		loadPortfolio();

			async function loadPortfolio() {
				try {
					const response = await fetch("/api/portfolio");
					if (!response.ok) {
						throw new Error("Failed to load portfolio");
					}
					const summary = await response.json();
					updateDashboard(summary);
				} catch (error) {
					console.error(error);
				}
			}

			function updateDashboard(summary) {
				totalUsdEl.textContent = state.currency.format(summary.totals.usd || 0);
				blockchainEl.textContent = state.currency.format(summary.totals.byCategory.blockchain || 0);
				physicalEl.textContent = state.currency.format(summary.totals.byCategory.physical || 0);
				lastUpdatedEl.textContent = new Date(summary.updatedAt).toLocaleString();
				renderAssetRows(summary.assets);
				renderChart(summary.assets);
			}

			function renderAssetRows(assets) {
				assetRowsEl.innerHTML = "";
				for (const asset of assets) {
					const row = document.createElement("tr");
					row.innerHTML = [
						`<td>${asset.label}</td>`,
						`<td>${describeAsset(asset)}</td>`,
						`<td>${formatQuantity(asset)}</td>`,
						`<td>${formatPrice(asset.usdPrice)}</td>`,
						`<td>${state.currency.format(asset.usdValue)}</td>`,
						`<td class="status-${asset.status}">${asset.status === "ok" ? "OK" : asset.message ?? "Check"}</td>`,
					].join("");
					assetRowsEl.appendChild(row);
				}
			}

			function renderChart(assets) {
				const ctx = chartCanvas.getContext("2d");
				ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
				const total = assets.reduce((sum, asset) => sum + Math.max(asset.usdValue, 0), 0);

				if (!total) {
					ctx.fillStyle = "rgba(90, 110, 148, 0.3)";
					ctx.beginPath();
					ctx.arc(chartCanvas.width / 2, chartCanvas.height / 2, chartCanvas.width / 3, 0, Math.PI * 2);
					ctx.fill();
					chartLegend.innerHTML = "<p>No holdings yet.</p>";
					return;
				}

				let startAngle = -Math.PI / 2;
				const radius = chartCanvas.width / 2.5;
				const centerX = chartCanvas.width / 2;
				const centerY = chartCanvas.height / 2;
				chartLegend.innerHTML = "";

				assets.forEach((asset, index) => {
					const slice = Math.max(asset.usdValue, 0);
					const angle = (slice / total) * Math.PI * 2;
					const color = state.colors[index % state.colors.length];

					ctx.beginPath();
					ctx.moveTo(centerX, centerY);
					ctx.arc(centerX, centerY, radius, startAngle, startAngle + angle);
					ctx.closePath();
					ctx.fillStyle = color;
					ctx.fill();

					startAngle += angle;

					const legendItem = document.createElement("div");
					legendItem.className = "legend-item";
					legendItem.innerHTML = `
						<span class="legend-swatch" style="background:${color}"></span>
						<span>${asset.label}</span>
						<strong>${((slice / total) * 100).toFixed(1)}%</strong>
					`;
					chartLegend.appendChild(legendItem);
				});
			}

			function describeAsset(asset) {
				if (asset.category === "blockchain") {
					return `${asset.chain?.toUpperCase()}\n${asset.address}`;
				}
				return `${asset.symbol} holding`;
			}

			function formatQuantity(asset) {
				const quantity = state.number.format(asset.quantity);
				if (asset.category === "blockchain") {
					return `${quantity} ${asset.chain?.toUpperCase()}`;
				}
				return `${quantity} ${asset.symbol === "GOLD" ? "troy oz" : "USD"}`;
			}

			function formatPrice(price) {
				if (!Number.isFinite(price) || price <= 0) {
					return "--";
				}
				return state.currency.format(price);
			}

		</script>
	</body>
</html>
