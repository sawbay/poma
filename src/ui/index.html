<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Portfolio Monitor Assistant</title>
		<style>
			:root {
				color-scheme: dark;
				font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
				background: #05070c;
				color: #f2f6ff;
			}
			body {
				margin: 0;
				min-height: 100vh;
				background: radial-gradient(circle at top left, #18243a, #05070c);
			}
			header {
				padding: 2rem 1.5rem 1rem;
				text-align: center;
			}
			header h1 {
				margin: 0;
				font-size: clamp(1.8rem, 3vw, 3rem);
				letter-spacing: 0.12em;
			}
			main {
				max-width: 1100px;
				margin: 0 auto;
				padding: 0 1.5rem 4rem;
				display: grid;
				gap: 1.5rem;
			}
			section {
				background: rgba(6, 10, 18, 0.8);
				border: 1px solid rgba(255, 255, 255, 0.08);
				border-radius: 18px;
				padding: 1.5rem;
				backdrop-filter: blur(12px);
			}
			#metrics {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
				gap: 1rem;
			}
			.metric-card {
				background: linear-gradient(135deg, rgba(63, 98, 171, 0.9), rgba(19, 30, 53, 0.95));
				border-radius: 16px;
				padding: 1rem 1.25rem;
				display: flex;
				flex-direction: column;
				gap: 0.4rem;
				box-shadow: 0 18px 40px rgba(3, 7, 18, 0.5);
			}
			.metric-card h2,
			.metric-card h3 {
				margin: 0;
				font-size: 0.85rem;
				text-transform: uppercase;
				letter-spacing: 0.08em;
				color: rgba(229, 236, 255, 0.8);
			}
			.metric-card p {
				margin: 0;
				font-size: 1.6rem;
				font-weight: 600;
			}
			#chart-container {
				display: grid;
				grid-template-columns: minmax(220px, 320px) 1fr;
				gap: 1.5rem;
				align-items: center;
			}
			#chart-canvas {
				width: 100%;
				max-width: 320px;
				height: auto;
				justify-self: center;
			}
			#chart-legend {
				display: flex;
				flex-direction: column;
				gap: 0.75rem;
			}
			.legend-item {
				display: grid;
				grid-template-columns: 16px 1fr auto;
				gap: 0.75rem;
				align-items: center;
			}
			.legend-swatch {
				width: 16px;
				height: 16px;
				border-radius: 50%;
			}
			table {
				width: 100%;
				border-collapse: collapse;
			}
			th,
			td {
				padding: 0.75rem 0.5rem;
				border-bottom: 1px solid rgba(255, 255, 255, 0.06);
				text-align: left;
			}
			th {
				font-size: 0.75rem;
				text-transform: uppercase;
				letter-spacing: 0.08em;
				color: rgba(186, 198, 223, 0.8);
			}
			td.status-ok {
				color: #6ee7a6;
			}
			td.status-error {
				color: #f08c8c;
			}
			#chat-section {
				display: grid;
				gap: 1rem;
			}
			#chat-log {
				border: 1px solid rgba(255, 255, 255, 0.06);
				border-radius: 14px;
				padding: 1rem;
				max-height: 360px;
				overflow-y: auto;
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}
			.chat-entry {
				display: flex;
				flex-direction: column;
				gap: 0.4rem;
			}
			.chat-bubble {
				max-width: 80%;
				padding: 0.75rem 1rem;
				border-radius: 12px;
				white-space: pre-wrap;
				line-height: 1.5;
				box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
			}
			.chat-entry[data-role="assistant"] .chat-bubble {
				background: rgba(27, 35, 55, 0.9);
				color: #dfe9ff;
				align-self: flex-start;
			}
			.chat-entry[data-role="user"] .chat-bubble {
				background: linear-gradient(135deg, rgba(80, 160, 255, 0.9), rgba(114, 92, 249, 0.95));
				color: #06101f;
				align-self: flex-end;
			}
			.chat-meta {
				font-size: 0.75rem;
				color: rgba(194, 205, 229, 0.7);
			}
			form {
				display: grid;
				grid-template-columns: 1fr auto;
				gap: 0.75rem;
			}
			textarea {
				border-radius: 12px;
				border: 1px solid rgba(255, 255, 255, 0.08);
				background: rgba(7, 12, 21, 0.9);
				color: inherit;
				min-height: 80px;
				padding: 0.85rem;
				font-family: inherit;
			}
			button {
				border: none;
				border-radius: 12px;
				background: linear-gradient(135deg, #66ccff, #7b6dff);
				color: #02050a;
				font-weight: 600;
				font-size: 1rem;
				padding: 0 1.5rem;
				cursor: pointer;
				box-shadow: 0 12px 30px rgba(102, 204, 255, 0.35);
			}
			button:disabled {
				opacity: 0.6;
				cursor: progress;
			}
			.sr-only {
				position: absolute;
				width: 1px;
				height: 1px;
				padding: 0;
				margin: -1px;
				overflow: hidden;
				clip: rect(0, 0, 0, 0);
				border: 0;
			}
			@media (max-width: 900px) {
				#chart-container {
					grid-template-columns: 1fr;
				}
				.chat-bubble {
					max-width: 100%;
				}
				form {
					grid-template-columns: 1fr;
				}
			}
		</style>
	</head>
	<body>
		<header>
			<h1>Portfolio Monitor Assistant</h1>
			<p>Track blockchain addresses and physical holdings, refresh prices daily, and tweak everything with chat.</p>
		</header>
		<main>
			<section id="metrics">
				<div class="metric-card">
					<h2>Total value</h2>
					<p id="total-usd">--</p>
				</div>
				<div class="metric-card">
					<h3>Blockchain</h3>
					<p id="blockchain-share">--</p>
				</div>
				<div class="metric-card">
					<h3>Physical</h3>
					<p id="physical-share">--</p>
				</div>
				<div class="metric-card">
					<h3>Last refresh</h3>
					<p id="last-updated">--</p>
				</div>
			</section>

			<section>
				<h2>Allocation</h2>
				<div id="chart-container">
					<canvas id="chart-canvas" width="320" height="320"></canvas>
					<div id="chart-legend"></div>
				</div>
			</section>

			<section>
				<h2>Holdings</h2>
				<div style="overflow-x: auto">
					<table>
						<thead>
							<tr>
								<th>Label</th>
								<th>Type</th>
								<th>Quantity</th>
								<th>Price</th>
								<th>Value</th>
								<th>Status</th>
							</tr>
						</thead>
						<tbody id="asset-rows"></tbody>
					</table>
				</div>
			</section>

			<section id="chat-section">
				<h2>Chat Controls</h2>
				<div id="chat-log" aria-live="polite"></div>
				<form id="chat-form">
					<label for="chat-input" class="sr-only">Chat message</label>
					<textarea id="chat-input" placeholder="e.g. add bitcoin 0x1234... named cold storage" required></textarea>
					<button type="submit">Send</button>
				</form>
			</section>
		</main>

		<script type="module">
			const state = {
				messages: [],
				currency: new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }),
				number: new Intl.NumberFormat("en-US", { maximumFractionDigits: 6 }),
				colors: ["#5f5bff", "#56d9ff", "#7ee085", "#f9a8d4", "#f97373", "#facc15"],
			};

			const totalUsdEl = document.getElementById("total-usd");
			const blockchainEl = document.getElementById("blockchain-share");
			const physicalEl = document.getElementById("physical-share");
			const lastUpdatedEl = document.getElementById("last-updated");
			const assetRowsEl = document.getElementById("asset-rows");
			const chartCanvas = document.getElementById("chart-canvas");
			const chartLegend = document.getElementById("chart-legend");
			const chatLog = document.getElementById("chat-log");
			const chatForm = document.getElementById("chat-form");
			const chatInput = document.getElementById("chat-input");

			init();

			async function init() {
				await loadPortfolio();
				appendChatEntry(
					"assistant",
					"Hi! Tell me which blockchain addresses or gold/USD holdings you want to track."
				);
				state.messages.push({ role: "assistant", content: "Ready to help with your portfolio." });
			}

			async function loadPortfolio() {
				try {
					const response = await fetch("/api/portfolio");
					if (!response.ok) {
						throw new Error("Failed to load portfolio");
					}
					const summary = await response.json();
					updateDashboard(summary);
				} catch (error) {
					console.error(error);
				}
			}

			chatForm.addEventListener("submit", async (event) => {
				event.preventDefault();
				const content = chatInput.value.trim();
				if (!content) {
					return;
				}

				appendChatEntry("user", content);
				state.messages.push({ role: "user", content });
				setFormDisabled(true);
				chatInput.value = "";

				try {
					const response = await fetch("/api/chat", {
						method: "POST",
						headers: { "content-type": "application/json" },
						body: JSON.stringify({ messages: state.messages }),
					});
					if (!response.ok) {
						throw new Error("Chat request failed");
					}
					const payload = await response.json();
					const reply = payload.reply ?? "Request processed.";
					appendChatEntry("assistant", formatAssistantReply(reply, payload.operations));
					state.messages.push({ role: "assistant", content: reply });
					if (payload.summary) {
						updateDashboard(payload.summary);
					}
				} catch (error) {
					appendChatEntry("assistant", "I hit an error handling that request. Try again.");
					console.error(error);
				} finally {
					setFormDisabled(false);
					chatInput.focus();
				}
			});

			function updateDashboard(summary) {
				totalUsdEl.textContent = state.currency.format(summary.totals.usd || 0);
				blockchainEl.textContent = state.currency.format(summary.totals.byCategory.blockchain || 0);
				physicalEl.textContent = state.currency.format(summary.totals.byCategory.physical || 0);
				lastUpdatedEl.textContent = new Date(summary.updatedAt).toLocaleString();
				renderAssetRows(summary.assets);
				renderChart(summary.assets);
			}

			function renderAssetRows(assets) {
				assetRowsEl.innerHTML = "";
				for (const asset of assets) {
					const row = document.createElement("tr");
					row.innerHTML = [
						`<td>${asset.label}</td>`,
						`<td>${describeAsset(asset)}</td>`,
						`<td>${formatQuantity(asset)}</td>`,
						`<td>${formatPrice(asset.usdPrice)}</td>`,
						`<td>${state.currency.format(asset.usdValue)}</td>`,
						`<td class="status-${asset.status}">${asset.status === "ok" ? "OK" : asset.message ?? "Check"}</td>`,
					].join("");
					assetRowsEl.appendChild(row);
				}
			}

			function renderChart(assets) {
				const ctx = chartCanvas.getContext("2d");
				ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
				const total = assets.reduce((sum, asset) => sum + Math.max(asset.usdValue, 0), 0);

				if (!total) {
					ctx.fillStyle = "rgba(90, 110, 148, 0.3)";
					ctx.beginPath();
					ctx.arc(chartCanvas.width / 2, chartCanvas.height / 2, chartCanvas.width / 3, 0, Math.PI * 2);
					ctx.fill();
					chartLegend.innerHTML = "<p>No holdings yet.</p>";
					return;
				}

				let startAngle = -Math.PI / 2;
				const radius = chartCanvas.width / 2.5;
				const centerX = chartCanvas.width / 2;
				const centerY = chartCanvas.height / 2;
				chartLegend.innerHTML = "";

				assets.forEach((asset, index) => {
					const slice = Math.max(asset.usdValue, 0);
					const angle = (slice / total) * Math.PI * 2;
					const color = state.colors[index % state.colors.length];

					ctx.beginPath();
					ctx.moveTo(centerX, centerY);
					ctx.arc(centerX, centerY, radius, startAngle, startAngle + angle);
					ctx.closePath();
					ctx.fillStyle = color;
					ctx.fill();

					startAngle += angle;

					const legendItem = document.createElement("div");
					legendItem.className = "legend-item";
					legendItem.innerHTML = `
						<span class="legend-swatch" style="background:${color}"></span>
						<span>${asset.label}</span>
						<strong>${((slice / total) * 100).toFixed(1)}%</strong>
					`;
					chartLegend.appendChild(legendItem);
				});
			}

			function describeAsset(asset) {
				if (asset.category === "blockchain") {
					return `${asset.chain?.toUpperCase()}\n${asset.address}`;
				}
				return `${asset.symbol} holding`;
			}

			function formatQuantity(asset) {
				const quantity = state.number.format(asset.quantity);
				if (asset.category === "blockchain") {
					return `${quantity} ${asset.chain?.toUpperCase()}`;
				}
				return `${quantity} ${asset.symbol === "GOLD" ? "troy oz" : "USD"}`;
			}

			function formatPrice(price) {
				if (!Number.isFinite(price) || price <= 0) {
					return "--";
				}
				return state.currency.format(price);
			}

			function appendChatEntry(role, text) {
				const entry = document.createElement("div");
				entry.className = "chat-entry";
				entry.dataset.role = role;

				const meta = document.createElement("span");
				meta.className = "chat-meta";
				meta.textContent = role === "assistant" ? "Assistant" : "You";

				const bubble = document.createElement("div");
				bubble.className = "chat-bubble";
				bubble.textContent = text;

				entry.appendChild(meta);
				entry.appendChild(bubble);
				chatLog.appendChild(entry);
				chatLog.scrollTop = chatLog.scrollHeight;
			}

			function formatAssistantReply(reply, operations = []) {
				if (!operations.length) {
					return reply;
				}
				return [
					reply.trim(),
					"",
					"Operations:",
					...operations.map((operation) => `- [${operation.status}] ${operation.detail}`),
				].join("\n");
			}

			function setFormDisabled(disabled) {
				chatInput.disabled = disabled;
				chatForm.querySelector("button").disabled = disabled;
			}
		</script>
	</body>
</html>
